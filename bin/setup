#!/usr/bin/env sh

set -e

BOLD='\033[1m'
RED='\033[31m'
RESET='\033[0m'
YELLOW='\033[33m'

create_beam_port() {
  poudriere ports -c -f beam -m null -M "$(pwd)" -p beam
}

create_default_port() {
  poudriere ports -c
}

create_jail()  {
  local release=$1
  local name=$2
  local jail_arch=$3

  poudriere jail -c -j "${name}" -v "${release}" -a "${jail_arch}"
}

get_arch() {
  echo "$(uname -p)"
}

get_jails() {
  echo "$(poudriere jail -l)"
}

get_jail_arch() {
  local arch=$1

  if [ "${arch}" == "amd64" ]; then
    echo "${arch}"
    return 0
  elif [ "${arch}" == "aarch64" ]; then
    echo "arm64.aarch64"
    return 0
  fi
  return 1
}

get_ports() {
  echo "$(poudriere ports -l)"
}

main() {
  local arch="$(get_arch)"
  local jails="$(get_jails)"
  local jail_arch="$(get_jail_arch "${arch}")"
  local ports="$(get_ports)"

  if ! echo "${ports}" | grep -q "default"; then
    printf "${BOLD}== Creating port: default…${RESET}\n" >&2
    create_default_port
  else
    printf "${BOLD}== Creating port: default…             ${RESET}${YELLOW}[skipped]${RESET}\n" >&2
  fi

  if ! echo "${ports}" | grep -q "beam"; then
    printf "${BOLD}== Creating port: beam…${RESET}\n" >&2
    create_beam_port
  else
    printf "${BOLD}== Creating port: beam…                ${RESET}${YELLOW}[skipped]${RESET}\n" >&2
  fi

  if ! echo "${jails}" | grep -q "14.3-RELEASE"; then
    printf "${BOLD}== Creating jail: 14.3-RELEASE…${RESET}\n" >&2
    create_jail "14.3-RELEASE" "143${arch}" "${jail_arch}"
  else
    printf "${BOLD}== Creating jail: 14.3-RELEASE…        ${RESET}${YELLOW}[skipped]${RESET}\n" >&2
  fi

  if ! echo "${jails}" | grep -q "15.0-RELEASE"; then
    printf "${BOLD}== Creating jail: 15.0-RELEASE…${RESET}\n" >&2
    create_jail "15.0-RELEASE" "150${arch}" "${jail_arch}"
  else
    printf "${BOLD}== Creating jail: 15.0-RELEASE…        ${RESET}${YELLOW}[skipped]${RESET}\n" >&2
  fi
}

main
